KISSY.add("smf/coupon/apply",function(e,t){function o(e){var t=this;t.config=e,t.type=e.type?e.type:"hongbao",t.activityId=e.activityId,t.showItems=void 0!=e.showItems?e.showItems:!0,t.sellerId=e.sellerId,t.daily=void 0!=e.daily?e.daily:!1,t.applyChannel=e.applyChannel,t.isShop=e.isShop?!0:!1,t.token=e.token?e.token:"";var o="taoquan.taobao.com";t.daily&&(o="taoquan.daily.taobao.net"),"hongbao"==t.type?(t.cburl=e.cburl,t.applyUrl=location.protocol+"//"+o+"/coupon/shopbonus/buyer_share_apply.htm"):t.applyUrl=location.protocol+"//"+o+"/coupon/itemCoupon/item_coupon_promotion_apply.htm",t.init()}var e=KISSY,a=e.DOM,n=e.Event,s=function(e){return this instanceof s?(e=e||{},this.cburl=e.cburl,this.daily=!!e.daily,this.from=e.from,s.__INSTANCE__=this,this.available=!0,void this._init()):new s(e)};return e.augment(s,n.Target,{_init:function(){return e.namespace("Member.Weibo",!0),window.Member.Weibo.Bind=s,this.from&&this.cburl&&0===this.cburl.indexOf(window.location.protocol+"//"+window.location.host)?void(this.url=location.protocol+"//member1."+(this.daily?"daily.taobao.net":"taobao.com")+"/member/fresh/weibo_bind_management.htm"):(this.available=!1,this.fire("failure"),void alert("ERROR: no from/cburl param or domain not match."))},show:function(){return this.available?(this.o=new t.Dialog({prefixCls:"applyCoupon-",width:400,headerContent:"\u9886\u53d6\u7ea2\u5305\u9700\u8f6c\u53d1\u6d3b\u52a8\u5fae\u535a",bodyContent:'<iframe src="'+this.url+"?cburl="+this.cburl+"&from="+this.from+'" style="display:block;width:400px;height:355px;" scrolling="no" frameborder="0" allowtransparency="true"></iframe>',closable:!0,closeAction:"destroy",mask:!1,zIndex:1e9}),this.o.render(),this.o.center(),this.o.get("el").all(".applyCoupon-ext-close-x").html("\xd7"),this.o.show(),this._bindEvent(),this):this},hide:function(){return this.available?(this.o&&this.o.destroy(),this.o=null,this.fire("hide"),this):this},_bindEvent:function(){this.on("success failure",function(){this.hide()},this),this.o&&this.o.on("hide",function(){this.fire("hide"),this.fire("destroy")},this)}}),e.augment(o,n.Target,{init:function(){var e=this,t=!1;if(-1==window.location.href.indexOf("taobao"))t=!0;else{var o=function(e){var t,o;return(o=String(document.cookie).match(new RegExp("(?:^| )"+e+"(?:(?:=([^;]*))|;|$)")))&&(t=o[1]?decodeURIComponent(o[1]):""),t};t=!!(o("_l_g_")&&o("_nk_")||o("ck1")&&o("tracknick")||o("lgc"))}e.initLogin(t)},normalize:function(e){var t=this;return e=t.daily?e.replace("assets.alicdn.com","assets.daily.taobao.net").replace("taobao.com","daily.taobao.net"):e.replace("assets.daily.taobao.net","assets.alicdn.com").replace("daily.taobao.net","taobao.com")},initLogin:function(t){var o=this;if(0==t){goldlog.send(location.protocol+"//ga.mmstat.com/tbtwlact.2.2",{});var s=o.normalize("//login.taobao.com/member/login.jhtml?style=mini&is_ignore=false&full_redirect=true"),i='<div class="sns-login-content"><div class="sns-login-wrap"><div class="sns-login-title">\u6dd8\u5b9d\u4f1a\u5458</div><iframe width="330" height="285" frameborder="0"scrolling="no" src="'+s+'&redirect_url={redirectUrl}"></iframe></div><s style="display:{closeBtn}" class="sns-close-btn">&times;</s></div>',l=".sns-close-btn {    color:#9c9c97;    text-decoration:none;    font-size:22px;    position:absolute;    right:12px;    top:5px;    cursor:pointer;}.sns-popup-login {	position:absolute;}.sns-login-content {   border-radius: 3px;	border:3px solid #d5d5d5;	background-color:#FAFAFA;}.sns-login-wrap {   width: 330px;    border: 1px solid #aaa;   overflow: hidden; }.sns-login-title {   background: #f2f2f2;   height: 35px;   line-height: 35px;   font-size: 14px;   font-weight: 700;   color: #000;   padding-left: 15px;   margin-bottom: 25px;}";a.addStyleSheet(l);var c=new e.Overlay({elCls:"sns-popup-login",content:e.substitute(i,{closeBtn:"block",redirectUrl:encodeURIComponent(window.location.href)}),zIndex:1e9,mask:!1,align:{node:null,points:["cc","cc"],offset:[0,0]}});c.render(),c.show();var r;r=e.isFunction(c.get)?c.get("el").getDOMNode():c.container,n.on(a.get(".sns-close-btn",r),"click",function(){c.destroy()})}else e.io({url:o.applyUrl,data:{activityId:o.activityId,sellerId:o.sellerId,applyChannel:o.applyChannel},cache:!1,dataType:"jsonp",success:function(e){if(o.shopUrl=e.shopUrl,o.shopName=e.shopName,o.amount=e.amount,o.startTime=e.startTime,o.endTime=e.endTime,o.startFee=e.startFee,o.discount=e.discount,o.activeCenter=e.activeCenter,"true"==e.success)o.renderPop(e);else{if("NOT_LOGIN"==e.code)return void o.initLogin(!1);if("NOT_BIND_WEIBO"==e.code)return void o.weiboBind();if("SHARE_WEIBO"==e.code)return void o.share();if("PARAM_VALID"==e.code)return void alert(e.msg);"APPLY_ERROR"==e.code&&o.renderPop(e)}}})},weiboBind:function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.3",{});var e=this;s({cburl:e.cburl,daily:e.daily,from:"sns"}).show().on("success",function(){e.share(),goldlog.send("//ga.mmstat.com/tbtwlact.2.8",{})}).on("failure",function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.8",{})})},_getValue:function(t){var o=e.trim(a.attr(t,"placeholder")),n=e.trim(t.value),s=a.attr(t,"maxlength");return o===n?"":s&&n>=s?n.substr(0,s):n},encodeGBK:function(e){function t(e){return e?window.ActiveXObject?(execScript('SetLocale "zh-cn"',"vbscript"),e.replace(/[\d\D]/g,function(e){return window.vbsval="",execScript('window.vbsval=Hex(Asc(" '+e+'"))',"vbscript"),"%"+window.vbsval.slice(0,2)+"%"+window.vbsval.slice(-2)})):(o.src="//go.mmstat.com/jsclick?globaljs=1&separator="+e,o.src.split("&separator=").pop()):""}var o=document.createElement("img");return e.replace(/([^\x00-\xff]+)|([\x00-\xff]+)/g,function(e,o,a){return t(o)+encodeURIComponent(a||"")})},share:function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.1",{});var o=this,a=e.Cookie.get("_nk_")||e.Cookie.get("lgc");void 0!=a&&(a=e.fromUnicode(a)),o.shopName||(o.shopName="");var n='<div class=\'apply-coupon-content clearfix\'><div class="sns-content">\n<div class="article">\n    <div class="selected">\n        <span class="title">\u540c\u6b65\u5230:</span>\n        <i class="i-sina"></i>\n    </div>\n    <div class="item">\n        <div class="share-ipt">\n            <div class="user">\n                <img src="//wwc.alicdn.com/avatar/getAvatar.do?userNick='+o.encodeGBK(a).toLowerCase()+'&width=80&height=80&type=sns" width="40" height="40">\n                <span class="user-nick">'+a+'</span>\n            </div>\n            <div class="entry">\n                <textarea maxlength="140" class="J_SnsShareComment">#1212\u5e97\u94fa\u7ea2\u5305\u5927\u6d3e\u9001#\u8f7b\u8f7b\u677e\u677e\u5c31\u9886\u5230'+o.amount+"\u5757\u94b1\uff0c\u597d\u55e8\u68ee\uff01\uff01\u4f60\u60f3\u8981\u5417\uff1f"+o.shopName+'\u5e97\u94fa\u6b63\u5728\u53d1\u7ea2\u5305\uff0c\u5c0f\u4f19\u4f34\u4eec\u90fd\u62a2\u75af\u4e86\uff0c\u518d\u4e0d\u53bb\u5c31\u6ca1\u5566\uff01</textarea>\n            </div>\n            <p class="count hidden">\u8fd8\u53ef\u4ee5\u8f93\u5165 <em class="J_Count">135</em> \u4e2a\u5b57</p><s></s></div>\n    </div>\n</div>\n<div class="sns-share-widget-footer">\n    <div class="operate">\n        <a class="continue J_Continue J_Submit" href="">\u7acb\u5373\u5206\u4eab</a>\n        <a class="cancel J_Cancel J_Close" href="">\u53d6\u6d88</a>\n    </div>\n    <div class="J_ExtraInfo extra-info"></div>\n</div>\n</div></div>';o.amount||(n='<div class=\'apply-coupon-content clearfix\'><div class="sns-content">\n<div class="article">\n    <div class="selected">\n        <span class="title">\u540c\u6b65\u5230:</span>\n        <i class="i-sina"></i>\n    </div>\n    <div class="item">\n        <div class="share-ipt">\n            <div class="user">\n                <img src="//wwc.alicdn.com/avatar/getAvatar.do?userNick='+o.encodeGBK(a).toLowerCase()+'&width=80&height=80&type=sns" width="40" height="40">\n                <span class="user-nick">'+a+'</span>\n            </div>\n            <div class="entry">\n                <textarea maxlength="140" class="J_SnsShareComment">#1212\u5e97\u94fa\u7ea2\u5305\u5927\u6d3e\u9001#\u8f7b\u8f7b\u677e\u677e\u5c31\u9886\u5230\u7ea2\u5305\uff0c\u597d\u55e8\u68ee\uff01\uff01\u4f60\u60f3\u8981\u5417\uff1f'+o.shopName+'\u5e97\u94fa\u6b63\u5728\u53d1\u7ea2\u5305\uff0c\u5c0f\u4f19\u4f34\u4eec\u90fd\u62a2\u75af\u4e86\uff0c\u518d\u4e0d\u53bb\u5c31\u6ca1\u5566\uff01</textarea>\n            </div>\n            <p class="count hidden">\u8fd8\u53ef\u4ee5\u8f93\u5165 <em class="J_Count">135</em> \u4e2a\u5b57</p><s></s></div>\n    </div>\n</div>\n<div class="sns-share-widget-footer">\n    <div class="operate">\n        <a class="continue J_Continue J_Submit" href="">\u7acb\u5373\u5206\u4eab</a>\n        <a class="cancel J_Cancel J_Close" href="">\u53d6\u6d88</a>\n    </div>\n    <div class="J_ExtraInfo extra-info"></div>\n</div>\n</div></div>');var s=new t.Dialog({prefixCls:"applyCoupon-",zIndex:1e9,mask:!1,headerContent:"\u9886\u53d6\u7ea2\u5305\u9700\u8f6c\u53d1\u6d3b\u52a8\u5fae\u535a",bodyContent:n,closeable:!0,closeAction:"destroy"});s.render(),s.get("el").all(".applyCoupon-ext-close-x").html("\xd7"),s.center(),s.show(),s.get("el").one("textarea").on("focus",function(t){e.all(t.target).css("color","#000")}),s.get("el").one("textarea").on("blur",function(t){e.all(t.target).css("color","#999")}),o._maxlength(s.get("el").getDOMNode()),s.get("el").one(".J_Close").on("click",function(e){e.preventDefault(),goldlog.send("//ga.mmstat.com/tbtwlact.2.7",{}),s.destroy()}),s.get("el").one(".applyCoupon-ext-close-x").on("click",function(e){goldlog.send("//ga.mmstat.com/tbtwlact.2.7",{})}),s.get("el").one(".J_Submit").on("click",function(t){t.preventDefault(),goldlog.send("//ga.mmstat.com/tbtwlact.2.6",{}),e.io({url:o.applyUrl,data:{activityId:o.activityId,sellerId:o.sellerId,applyChannel:o.applyChannel,title:encodeURIComponent("\u6dd8\u5b9d\u7f51\u53cc\u5341\u4e8c\u5e97\u94fa\u7ea2\u5305\u6d3b\u52a8"),comment:encodeURIComponent(o._getValue(s.get("el").all(".J_SnsShareComment").getDOMNode())),link:o.activeCenter},dataType:"jsonp",cache:!1,success:function(e){if(s.destroy(),"true"==e.success)goldlog.send("//ga.mmstat.com/tbtwlact.2.5",{activityId:o.activityId,sellerId:o.sellerId,applyChannel:o.applyChannel}),o.renderPop(e);else{if("PARAM_VALID"==e.code)return void alert(e.msg);"APPLY_ERROR"==e.code&&o.renderPop(e)}}})})},hasParam:function(e){return e.indexOf("?")>-1?e+"&":e+"?"},_maxlength:function(e){var t="maxLength"in document.createElement("textarea");if(!t){var o=e.getAttribute("maxlength");n.on(e,"valuechange",function(t){e.value.length>o&&(e.value=e.value.substring(0,o))})}},renderPop:function(o){var s=this,i="",l="",c='<div style="margin-top: 13px;color: #666;"><a class="J_close">\u786e \u5b9a</a>',r="";"hongbao"==s.type?(r="1223.1.10",goldlog.send("//ga.mmstat.com/tbtwlact.1.1",{})):(r="1223.2.10",goldlog.send("//ga.mmstat.com/tbtwlact.3.1",{}));var d='<div class="applyCouponResult"><div class="close">\xd7</div> <div class="results">';if("true"==o.success){goldlog.send("//ga.mmstat.com/shopcoupons.1.* ",{});var p=!1;if(s.fire("success"),d+=' <div class="label suc"></div>',o.startTime=o.startTime.slice(0,10).replace("-",".").replace("-","."),o.endTime=o.endTime.slice(0,10).replace("-",".").replace("-","."),"hongbao"==s.type){var m="";o.amount&&(m='<span class="red"><span class="money">\uffe5</span>'+o.amount+"</span>"),i="\u606d\u559c\uff0c\u60a8\u5df2\u6210\u529f\u9886\u53d6"+m+'\u5e97\u94fa\u7ea2\u5305\u3002<a target="_blank" href="//taoquan.taobao.com/framework/got_bonus.htm?scm=1223.1.10.1&tabIndex=5" style="font-size: 12px">\u67e5\u770b></a></div>',i+='<div class="date">\u4f7f\u7528\u65f6\u95f4\uff1a'+o.startTime+"-"+o.endTime+" \u5168\u5e97\u901a\u7528</div>",l="<div>"}else{var m="";o.startFee&&o.discount&&(m='<span class="red">\u6ee1'+o.startFee+"\u51cf"+o.discount+"\u5143</span>"),i="\u606d\u559c\uff0c\u60a8\u5df2\u6210\u529f\u9886\u53d6"+m+'\u5546\u54c1\u4f18\u60e0\u5238\u3002</div><div class="date">\u4f7f\u7528\u65f6\u95f4\uff1a'+o.startTime+"-"+o.endTime,o.shopUrl&&(i+='<a href="'+s.hasParam(o.shopUrl)+"scm="+r+'.4" target="_blank">\u67e5\u770b\u9002\u7528\u5b9d\u8d1d</a>'),i+="</div>"}p&&(c+='<span style="*vertical-align: bottom"><input checked="checked" class="J_collect" type="checkbox">\u6536\u85cf\u8be5\u5e97</span>')}else goldlog.send("//ga.mmstat.com/shopcoupons.2.* ",{}),d+='<div class="label fail"></div>',s.fire("fail"),i=o.msg+"</div>","hongbao"==s.type&&(l='<a target="_blank" href="//taoquan.taobao.com/framework/got_bonus.htm?scm=1223.1.10.1&tabIndex=5" style="font-size: 12px">\u67e5\u770b\u5df2\u9886\u5230\u7684\u5e97\u94fa\u7ea2\u5305></a>');c+="</div>","hongbao"!=s.type&&(!s.isShop&&o.activeCenter&&(i+='<div><a href="'+s.hasParam(o.activeCenter)+"scm="+r+'.1" target="_blank">\u67e5\u770b\u8be5\u5e97\u66f4\u591a\u4f18\u60e0</a></div>'),l=' <div>\u67e5\u770b\u5df2\u9886\u5546\u54c1\u4f18\u60e0\u5238\uff1a<a href="//taoquan.taobao.com/framework/got_bonus.htm?tabIndex=2&display=true&tabDomId=itemCouponTab&scm='+r+'.2" target="_blank">\u6211\u7684\u4f18\u60e0\u4fe1\u606f</a></div>'),d+=' <div class="result-text"><div class="result">'+i+'<div class="gray">'+l+" </div>"+c+"</div> </div> ",d+="</div>";var h=new t.Popup({prefixCls:"applyCoupon-",zIndex:1e9,mask:!1,content:d,closeable:!0,closeAction:"destroy"});h.render(),h.center(),h.show(),n.on(a.get(".close",h.get("el")),"click",function(e){h.destroy()}),n.on(a.get(".J_close",h.get("el")),"click",function(t){var n=a.get(".J_collect",h.get("el"));if(n&&a.prop(n,"checked")){var i;i=s.daily?"//favorite.daily.taobao.net/json/addCollectionForAll.htm":"//favorite.taobao.com/json/addCollectionForAll.htm",e.io({url:i,data:{shopId:o.shopId,favType:0},dataType:"jsonp",cache:"false"})}h.destroy()})}}),o},{requires:["overlay"]});